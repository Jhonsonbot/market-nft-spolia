<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini NFT Market – Sepolia</title>
  <style>
    :root{--bg:#0f1220;--card:#171a2b;--muted:#8892b0;--ink:#e6e9f5;--accent:#7aa2ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,sans-serif;color:var(--ink);background:linear-gradient(180deg,#0b0e1a, #101428)}
    header{position:sticky;top:0;background:#0e1223cc;border-bottom:1px solid #202642;backdrop-filter: blur(8px);z-index:10}
    .wrap{max-width:1080px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button,.btn{background:var(--accent);color:#0b0e1a;border:0;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .pill{padding:8px 12px;border:1px solid #2a3157;border-radius:999px;color:var(--muted)}
    main{padding:24px 16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid #242a49;border-radius:16px;overflow:hidden;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .card .body{padding:12px}
    .muted{color:var(--muted)}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3157;background:#12162a;color:var(--ink)}
    label{display:block;margin:8px 0 6px;font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:8px;margin:16px 0}
    .tab{padding:8px 12px;border-radius:12px;border:1px solid #2a3157;color:var(--ink);cursor:pointer}
    .tab.active{background:#1b2141}
    img{display:block;width:100%;aspect-ratio:1/1;object-fit:cover;background:#0d1020}
    .row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .warn{color:#ffcc66}
    .ok{color:#79ffa6}
    .err{color:#ff8080}
    footer{opacity:.8;padding:40px 16px;border-top:1px solid #242a49}
    .small{font-size:12px}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>Mini NFT Market · Sepolia</h1>
      <div class="row" style="margin-left:auto;gap:8px">
        <span id="networkTag" class="pill">Network: —</span>
        <span id="accountTag" class="pill">Wallet: —</span>
       <button id="connectWallet">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="row" style="gap:12px;flex-wrap:wrap;margin-bottom:8px">
      <div class="pill">NFT Contract: <span id="nftAddrLabel" class="code"></span></div>
      <div class="pill">Marketplace: <span id="marketAddrLabel" class="code"></span></div>
      <div class="pill">Fee: <span id="feeLabel">—</span></div>
    </section>

    <div class="tabs">
      <button class="tab active" data-tab="my">My NFTs</button>
      <button class="tab" data-tab="market">Marketplace</button>
    </div>

    <section id="panel-my">
      <div class="row-between" style="margin: 8px 0 16px">
        <div class="muted">NFT milik wallet kamu (koleksi target di Sepolia).</div>
        <div class="row" style="gap:8px">
          <button id="btnRefreshMy" class="btn" style="background:#2ad4b7">Refresh</button>
          <button id="btnApprove" class="btn">Set ApprovalForAll</button>
        </div>
      </div>
      <div id="myList" class="grid"></div>
      <p class="small muted" style="margin-top:12px">Catatan: agar bisa list, perlu <b>setApprovalForAll</b> ke Marketplace. Jika sudah, tombol di atas akan menunjukkan statusnya.</p>
    </section>

    <section id="panel-market" hidden>
      <div class="row-between" style="margin: 8px 0 16px">
        <div class="muted">Semua listing aktif dari kontrak marketplace.</div>
        <div class="row" style="gap:8px">
          <button id="btnRefreshMarket" class="btn" style="background:#9b84ff">Refresh</button>
        </div>
      </div>
      <div id="marketList" class="grid"></div>
    </section>
  </main>

  <footer class="wrap small muted">
    <div>Built with ethers.js v6 · Sepolia chainId <span class="code">11155111</span>. Ganti alamat NFT/Marketplace di bagian config dalam file ini.</div>
  </footer>

<script>
// =========================
// CONFIG – GANTI ALAMAT MU
// =========================
const NFT_ADDR = "0x4539dA97ddeF6142BCb3259C8a7de703C52cf76B";          // ERC-721 (disarankan ERC721Enumerable)
const MARKET_ADDR = "0xb871eDc06E6FeE83e993e5801fFE5FD9d060697C";       // Marketplace yang kamu deploy

// ABI minimal yang diperlukan
const ERC721_ENUM_ABI = [
  "function balanceOf(address owner) view returns (uint256)",
  "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
  "function tokenURI(uint256 tokenId) view returns (string)",
  "function isApprovedForAll(address owner, address operator) view returns (bool)",
  "function setApprovalForAll(address operator, bool approved)",
  "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)"
];

const MARKET_ABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"inputs": [],
		"name": "ReentrancyGuardReentrantCall",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "oldFeeBps",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newFeeBps",
				"type": "uint256"
			}
		],
		"name": "FeeBpsUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "FeesWithdrawn",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "nft",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "seller",
				"type": "address"
			}
		],
		"name": "NFTCancelled",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "nft",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "NFTListed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "nft",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "fee",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "royalty",
				"type": "uint256"
			}
		],
		"name": "NFTSold",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"inputs": [],
		"name": "MAX_FEE_BPS",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "accruedFees",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "nftAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "buyNFT",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "nftAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "cancelListing",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "feeBps",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "nftAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "getListing",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "seller",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "price",
						"type": "uint256"
					}
				],
				"internalType": "struct NFTMarketplace.Listing",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "nftAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"name": "listNFT",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "listings",
		"outputs": [
			{
				"internalType": "address",
				"name": "seller",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "newFeeBps",
				"type": "uint256"
			}
		],
		"name": "setFeeBps",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "withdrawFees",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	}
];

// =============
// STATE & UTIL
// =============
let provider, signer, account, nft, market;

const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>document.querySelectorAll(sel);

const ipfsToHttp = (uri) => {
  if (!uri) return uri;
  if (uri.startsWith("ipfs://")) {
    return uri.replace("ipfs://", "https://ipfs.io/ipfs/");
  }
  return uri;
};

const fmt = (wei) => {
  try { return ethers.formatEther(wei); } catch { return "0"; }
};

async function connect(){
  if (!window.ethereum) {
    alert('Install MetaMask.');
    return;
  }

  provider = new ethers.BrowserProvider(window.ethereum);

  // minta izin akun
  await provider.send('eth_requestAccounts', []);
  signer = await provider.getSigner();
  account = await signer.getAddress();

  // cek network
  const net = await provider.getNetwork();
  if (Number(net.chainId) !== 11155111){
    try {
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: '0xaa36a7' }], // sepolia
      });
    } catch(e){
      alert('Please switch to Sepolia network.');
      console.warn(e);
    }
  }

  // update UI
  $('#accountTag').textContent = `Wallet: ${account.slice(0,6)}…${account.slice(-4)}`;
  $('#networkTag').textContent = `Network: Sepolia`;

  // init kontrak
  nft = new ethers.Contract(NFT_ADDR, ERC721_ENUM_ABI, signer);
  market = new ethers.Contract(MARKET_ADDR, MARKET_ABI, signer);

  // tampilkan fee
  try {
    const fee = await market.feeBps();
    $('#feeLabel').textContent = `${fee} bps (${(Number(fee)/100).toFixed(2)}%)`;
  } catch(e) {
    console.warn("Gagal ambil fee:", e);
  }

  await refreshApprovalBadge();
  await loadMyNfts();
  await loadMarket();
}

function onTab(e){
  $$('.tab').forEach(t=>t.classList.remove('active'));
  e.currentTarget.classList.add('active');
  const key = e.currentTarget.dataset.tab;
  $('#panel-my').hidden = key !== 'my';
  $('#panel-market').hidden = key !== 'market';
}

// ======================
// APPROVAL
// ======================
async function refreshApprovalBadge(){
  if(!nft || !account) return;
  try {
    const ok = await nft.isApprovedForAll(account, MARKET_ADDR);
    $('#btnApprove').textContent = ok ? 'Approved ✓' : 'Set ApprovalForAll';
    $('#btnApprove').disabled = ok;
  } catch(e){ console.warn(e); }
}

async function setApprovalAll(){
  if(!nft) return;
  try{
    const tx = await nft.setApprovalForAll(MARKET_ADDR, true);
    await tx.wait();
    await refreshApprovalBadge();
    alert('Approval set!');
  }catch(e){ alert('Approval failed'); console.error(e); }
}

// ======================
// LOAD MY NFTS
// ======================
async function loadMyNfts(){
  if(!nft || !account){ $('#myList').innerHTML = '<p class="muted">Connect wallet dulu.</p>'; return; }
  $('#myList').innerHTML = '<p class="muted">Loading…</p>';
  try{
    const bal = await nft.balanceOf(account);
    const total = Number(bal);
    if(total===0){ $('#myList').innerHTML = '<p class="muted">Tidak ada NFT pada koleksi ini.</p>'; return; }

    const items = [];
    for(let i=0;i<total;i++){
      const tokenId = await nft.tokenOfOwnerByIndex(account, i);
      items.push(Number(tokenId));
    }

    const cards = await Promise.all(items.map(renderMyCard));
    $('#myList').innerHTML = cards.join('');

    // attach handlers
    items.forEach(id => {
      const btn = document.getElementById(`btnList-${id}`);
      if(btn){ btn.addEventListener('click', ()=> listToken(id)); }
    });
  }catch(e){
    console.error(e);
    $('#myList').innerHTML = '<p class="err">Gagal load NFT. Pastikan kontrak ERC721Enumerable.</p>';
  }
}

async function renderMyCard(tokenId){
  try{
    const uri = await nft.tokenURI(tokenId);
    const metaUrl = ipfsToHttp(uri);
    let name = `#${tokenId}`; let img=''; let desc='';
    try{
      const res = await fetch(metaUrl);
      const j = await res.json();
      name = j.name || name;
      img = ipfsToHttp(j.image || '');
      desc = j.description || '';
    }catch{}

    return `
      <div class="card">
        <img src="${img||''}" alt="NFT ${tokenId}" onerror="this.style.display='none'"/>
        <div class="body">
          <div class="row-between"><strong>${name}</strong><span class="muted">ID ${tokenId}</span></div>
          <p class="muted" style="min-height:2.2em">${desc}</p>
          <label>Price (ETH)</label>
          <input id="price-${tokenId}" placeholder="0.01" />
          <div style="height:8px"></div>
          <button id="btnList-${tokenId}">List for Sale</button>
        </div>
      </div>`;
  }catch{
    return `<div class="card"><div class="body">Token ${tokenId}</div></div>`;
  }
}

// ======================
// LIST TOKEN
// ======================
async function listToken(tokenId){
  const priceStr = (document.getElementById(`price-${tokenId}`)?.value || '').trim();
  if(!priceStr){ alert('Isi harga dalam ETH, mis. 0.01'); return; }
  try{
    const wei = ethers.parseEther(priceStr);
    const tx = await market.list(NFT_ADDR, tokenId, wei);
    await tx.wait();
    alert('Listed!');
    await loadMarket();
  }catch(e){
    console.error(e);
    alert('List gagal. Pastikan sudah ApprovalForAll.');
  }
}

// ======================
// LOAD MARKET LISTINGS
// ======================
async function loadMarket(){
  if(!market){ $('#marketList').innerHTML = '<p class="muted">Connect wallet dulu.</p>'; return; }
  $('#marketList').innerHTML = '<p class="muted">Loading…</p>';
  try{
    const nextId = await market.nextListingId();
    const max = Number(nextId);
    const active = [];
    for(let id=1; id<=max; id++){
      const L = await market.listings(id);
      if(L.active && String(L.nft).toLowerCase() === NFT_ADDR.toLowerCase()){
        active.push({id, seller:L.seller, tokenId: Number(L.tokenId), price: L.price});
      }
    }
    if(active.length===0){ $('#marketList').innerHTML = '<p class="muted">Belum ada listing aktif.</p>'; return; }

    const cards = await Promise.all(active.map(renderMarketCard));
    $('#marketList').innerHTML = cards.join('');

    active.forEach(({id})=>{
      const b = document.getElementById(`btnBuy-${id}`);
      if(b){ b.addEventListener('click', ()=> buyListing(id)); }
      const c = document.getElementById(`btnCancel-${id}`);
      if(c){ c.addEventListener('click', ()=> cancelListing(id)); }
    });
  }catch(e){
    console.error(e);
    $('#marketList').innerHTML = '<p class="err">Gagal load listing.</p>';
  }
}

async function renderMarketCard(item){
  const {id, tokenId, price, seller} = item;
  let name = `#${tokenId}`; let img=''; let desc='';
  try{
    const uri = await nft.tokenURI(tokenId);
    const metaUrl = ipfsToHttp(uri);
    const j = await (await fetch(metaUrl)).json();
    name = j.name || name; img = ipfsToHttp(j.image||''); desc = j.description || '';
  }catch{}
  const isSeller = account && seller && account.toLowerCase()===seller.toLowerCase();
  return `
    <div class="card">
      <img src="${img||''}" alt="NFT ${tokenId}" onerror="this.style.display='none'"/>
      <div class="body">
        <div class="row-between"><strong>${name}</strong><span class="muted">#${tokenId}</span></div>
        <p class="muted" style="min-height:2.2em">${desc}</p>
        <div class="row-between">
          <div>
            <div class="muted small">Listing ID</div>
            <div class="code">${id}</div>
          </div>
          <div style="text-align:right">
            <div class="muted small">Price</div>
            <div><b>${fmt(price)} ETH</b></div>
          </div>
        </div>
        <div style="height:8px"></div>
        ${isSeller
          ? `<button id="btnCancel-${id}" style="background:#ff8080">Cancel</button>`
          : `<button id="btnBuy-${id}">Buy</button>`}
      </div>
    </div>`;
}

// ======================
// BUY / CANCEL
// ======================
async function buyListing(id){
  try{
    const L = await market.listings(id);
    if(!L.active){ alert('Listing tidak aktif'); return; }
    const tx = await market.buy(id, { value: L.price });
    await tx.wait();
    alert('Purchase success!');
    await loadMarket();
    await loadMyNfts();
  }catch(e){ console.error(e); alert('Buy failed'); }
}

async function cancelListing(id){
  try{
    const tx = await market.cancel(id);
    await tx.wait();
    alert('Canceled');
    await loadMarket();
  }catch(e){ console.error(e); alert('Cancel failed'); }
}
</script>
</body>
</html>



